<!DOCTYPE html>
<html lang="zh-CN">
<head>
  <meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1, maximum-scale=2">
<meta name="theme-color" content="#222">
<meta name="generator" content="Hexo 7.3.0">
  <link rel="apple-touch-icon" sizes="180x180" href="/images/apple-touch-icon-next.png">
  <link rel="icon" type="image/png" sizes="32x32" href="/images/favicon-32x32-next.png">
  <link rel="icon" type="image/png" sizes="16x16" href="/images/favicon-16x16-next.png">
  <link rel="mask-icon" href="/images/logo.svg" color="#222">

<link rel="stylesheet" href="/css/main.css">


<link rel="stylesheet" href="/lib/font-awesome/css/all.min.css">

<script id="hexo-configurations">
    var NexT = window.NexT || {};
    var CONFIG = {"hostname":"suwangsuwang.github.io","root":"/","scheme":"Muse","version":"7.8.0","exturl":false,"sidebar":{"position":"left","display":"post","padding":18,"offset":12,"onmobile":false},"copycode":{"enable":false,"show_result":false,"style":null},"back2top":{"enable":true,"sidebar":false,"scrollpercent":false},"bookmark":{"enable":false,"color":"#222","save":"auto"},"fancybox":false,"mediumzoom":false,"lazyload":false,"pangu":false,"comments":{"style":"tabs","active":null,"storage":true,"lazyload":false,"nav":null},"algolia":{"hits":{"per_page":10},"labels":{"input_placeholder":"Search for Posts","hits_empty":"We didn't find any results for the search: ${query}","hits_stats":"${hits} results found in ${time} ms"}},"localsearch":{"enable":false,"trigger":"auto","top_n_per_article":1,"unescape":false,"preload":false},"motion":{"enable":true,"async":false,"transition":{"post_block":"fadeIn","post_header":"slideDownIn","post_body":"slideDownIn","coll_header":"slideLeftIn","sidebar":"slideUpIn"}},"path":"search.xml"};
  </script>

  <meta name="description" content="本文详细介绍了 iOS 中 Core Data 框架的使用方法，包括组件结构、设置堆栈、数据模型设计、CRUD 操作等内容，适合 iOS 开发者学习数据持久化技术。">
<meta property="og:type" content="article">
<meta property="og:title" content="Core-Data">
<meta property="og:url" content="https://suwangsuwang.github.io/2016/08/15/Core-Data/index.html">
<meta property="og:site_name" content="suwang Tech Blog">
<meta property="og:description" content="本文详细介绍了 iOS 中 Core Data 框架的使用方法，包括组件结构、设置堆栈、数据模型设计、CRUD 操作等内容，适合 iOS 开发者学习数据持久化技术。">
<meta property="og:locale" content="zh_CN">
<meta property="article:published_time" content="2016-08-15T04:23:06.000Z">
<meta property="article:modified_time" content="2016-08-15T04:23:06.000Z">
<meta property="article:author" content="suwang">
<meta property="article:tag" content="iOS">
<meta property="article:tag" content="Core Data">
<meta property="article:tag" content="数据存储">
<meta property="article:tag" content="数据库">
<meta property="article:tag" content="持久化">
<meta name="twitter:card" content="summary">

<link rel="canonical" href="https://suwangsuwang.github.io/2016/08/15/Core-Data/">


<script id="page-configurations">
  // https://hexo.io/docs/variables.html
  CONFIG.page = {
    sidebar: "",
    isHome : false,
    isPost : true,
    lang   : 'zh-CN'
  };
</script>

  <title>Core-Data | suwang Tech Blog</title>
  






  <noscript>
  <style>
  .use-motion .brand,
  .use-motion .menu-item,
  .sidebar-inner,
  .use-motion .post-block,
  .use-motion .pagination,
  .use-motion .comments,
  .use-motion .post-header,
  .use-motion .post-body,
  .use-motion .collection-header { opacity: initial; }

  .use-motion .site-title,
  .use-motion .site-subtitle {
    opacity: initial;
    top: initial;
  }

  .use-motion .logo-line-before i { left: initial; }
  .use-motion .logo-line-after i { right: initial; }
  </style>
</noscript>

</head>

<body itemscope itemtype="http://schema.org/WebPage">
  <div class="container use-motion">
    <div class="headband"></div>

    <header class="header" itemscope itemtype="http://schema.org/WPHeader">
      <div class="header-inner"><div class="site-brand-container">
  <div class="site-nav-toggle">
    <div class="toggle" aria-label="切换导航栏">
      <span class="toggle-line toggle-line-first"></span>
      <span class="toggle-line toggle-line-middle"></span>
      <span class="toggle-line toggle-line-last"></span>
    </div>
  </div>

  <div class="site-meta">

    <a href="/" class="brand" rel="start">
      <span class="logo-line-before"><i></i></span>
      <h1 class="site-title">suwang Tech Blog</h1>
      <span class="logo-line-after"><i></i></span>
    </a>
      <p class="site-subtitle" itemprop="description">Tech Blog</p>
  </div>

  <div class="site-nav-right">
    <div class="toggle popup-trigger">
    </div>
  </div>
</div>




<nav class="site-nav">
  <ul id="menu" class="main-menu menu">
        <li class="menu-item menu-item-home">

    <a href="/" rel="section"><i class="fa fa-home fa-fw"></i>首页</a>

  </li>
        <li class="menu-item menu-item-archives">

    <a href="/archives/" rel="section"><i class="fa fa-archive fa-fw"></i>归档</a>

  </li>
  </ul>
</nav>




</div>
    </header>

    
  <div class="back-to-top">
    <i class="fa fa-arrow-up"></i>
    <span>0%</span>
  </div>


    <main class="main">
      <div class="main-inner">
        <div class="content-wrap">
          

          <div class="content post posts-expand">
            

    
  
  
  <article itemscope itemtype="http://schema.org/Article" class="post-block" lang="zh-CN">
    <link itemprop="mainEntityOfPage" href="https://suwangsuwang.github.io/2016/08/15/Core-Data/">

    <span hidden itemprop="author" itemscope itemtype="http://schema.org/Person">
      <meta itemprop="image" content="/images/avatar.gif">
      <meta itemprop="name" content="suwang">
      <meta itemprop="description" content="Tech Blog">
    </span>

    <span hidden itemprop="publisher" itemscope itemtype="http://schema.org/Organization">
      <meta itemprop="name" content="suwang Tech Blog">
    </span>
      <header class="post-header">
        <h1 class="post-title" itemprop="name headline">
          Core-Data
        </h1>

        <div class="post-meta">
            <span class="post-meta-item">
              <span class="post-meta-item-icon">
                <i class="far fa-calendar"></i>
              </span>
              <span class="post-meta-item-text">发表于</span>

              <time title="创建时间：2016-08-15 12:23:06" itemprop="dateCreated datePublished" datetime="2016-08-15T12:23:06+08:00">2016-08-15</time>
            </span>
            <span class="post-meta-item">
              <span class="post-meta-item-icon">
                <i class="far fa-folder"></i>
              </span>
              <span class="post-meta-item-text">分类于</span>
                <span itemprop="about" itemscope itemtype="http://schema.org/Thing">
                  <a href="/categories/iOS%E5%BC%80%E5%8F%91/" itemprop="url" rel="index"><span itemprop="name">iOS开发</span></a>
                </span>
                  ，
                <span itemprop="about" itemscope itemtype="http://schema.org/Thing">
                  <a href="/categories/iOS%E5%BC%80%E5%8F%91/%E6%95%B0%E6%8D%AE%E7%AE%A1%E7%90%86/" itemprop="url" rel="index"><span itemprop="name">数据管理</span></a>
                </span>
            </span>

          
            <div class="post-description">本文详细介绍了 iOS 中 Core Data 框架的使用方法，包括组件结构、设置堆栈、数据模型设计、CRUD 操作等内容，适合 iOS 开发者学习数据持久化技术。</div>

        </div>
      </header>

    
    
    
    <div class="post-body" itemprop="articleBody">

      
        <h1 id="包含组件"><a href="#包含组件" class="headerlink" title="包含组件"></a>包含组件</h1><p>最底层File System -&gt; SQLite -&gt; NSPersistent Store（可有多个） -&gt; NSPersistent StoreCoordinator -&gt; NSManagedObjectContext（可有多个，每个可包含多个NSManagedObject）</p>
<h1 id="设置堆栈"><a href="#设置堆栈" class="headerlink" title="设置堆栈"></a>设置堆栈</h1><p>范例：<a target="_blank" rel="noopener" href="https://github.com/objcio/issue-4-full-core-data-application">https://github.com/objcio/issue-4-full-core-data-application</a></p>
<span id="more"></span>

<figure class="highlight objc"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br></pre></td><td class="code"><pre><span class="line">- (<span class="type">void</span>)setupManagedObjectContext</span><br><span class="line"></span><br><span class="line">&#123;</span><br><span class="line"></span><br><span class="line">     <span class="comment">//使用initWithConcurrencyType:来明确使用的是基于队列的并发模型</span></span><br><span class="line"></span><br><span class="line">     <span class="keyword">self</span>.managedObjectContext = [[<span class="built_in">NSManagedObjectContext</span> alloc] initWithConcurrencyType:<span class="built_in">NSMainQueueConcurrencyType</span>];</span><br><span class="line"></span><br><span class="line">     <span class="keyword">self</span>.managedObjectContext.persistentStoreCoordinator = [[<span class="built_in">NSPersistentStoreCoordinator</span> alloc] initWithManagedObjectModel:<span class="keyword">self</span>.managedObjectModel];</span><br><span class="line"></span><br><span class="line">     <span class="built_in">NSError</span>* error;</span><br><span class="line"></span><br><span class="line">     [<span class="keyword">self</span>.managedObjectContext.persistentStoreCoordinator</span><br><span class="line"></span><br><span class="line">          addPersistentStoreWithType:<span class="built_in">NSSQLiteStoreType</span></span><br><span class="line"></span><br><span class="line">          configuration:<span class="literal">nil</span></span><br><span class="line"></span><br><span class="line">          URL:<span class="keyword">self</span>.storeURL</span><br><span class="line"></span><br><span class="line">          options:<span class="literal">nil</span></span><br><span class="line"></span><br><span class="line">          error:&amp;error];</span><br><span class="line"></span><br><span class="line">     <span class="keyword">if</span> (error) &#123;</span><br><span class="line"></span><br><span class="line">          <span class="built_in">NSLog</span>(<span class="string">@&quot;error: %@&quot;</span>, error);</span><br><span class="line"></span><br><span class="line">     &#125;</span><br><span class="line"></span><br><span class="line">     <span class="keyword">self</span>.managedObjectContext.undoManager = [[<span class="built_in">NSUndoManager</span> alloc] init];</span><br><span class="line"></span><br><span class="line">&#125;</span><br><span class="line"></span><br></pre></td></tr></table></figure>

<h1 id="创建模型"><a href="#创建模型" class="headerlink" title="创建模型"></a>创建模型</h1><p>在xcode新建的Core Data选项中选择Data Model template，模型文件会被编译成.momd文件。模型创建完毕就可以创建与之对应的NSManagedObject子类。从菜单选择Editor &gt; NSManagedObject subclass。</p>
<h2 id="模型的属性"><a href="#模型的属性" class="headerlink" title="模型的属性"></a>模型的属性</h2><ul>
<li>默认&#x2F;可选：建议不使用带默认值的可选属性</li>
<li>Transient：方便撤销操作和故障处理，建议使用transient属性</li>
<li>索引：提高读取速度</li>
<li>标量类型：默认NSNumber，也可以使用int64_t，float_t或BOOL。</li>
</ul>
<h1 id="创建Store类"><a href="#创建Store类" class="headerlink" title="创建Store类"></a>创建Store类</h1><p>存储类除了managed object context还有rootItem方法，程序启动时会查找这root item然后传给root view controller。</p>
<figure class="highlight objc"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br></pre></td><td class="code"><pre><span class="line">- (Item*)rootItem</span><br><span class="line"></span><br><span class="line">&#123;</span><br><span class="line"></span><br><span class="line">     <span class="built_in">NSFetchRequest</span>* request = [<span class="built_in">NSFetchRequest</span> fetchRequestWithEntityName:<span class="string">@&quot;Item&quot;</span>];</span><br><span class="line"></span><br><span class="line">     request.predicate = [<span class="built_in">NSPredicate</span> predicateWithFormat:<span class="string">@&quot;parent = %@&quot;</span>, <span class="literal">nil</span>];</span><br><span class="line"></span><br><span class="line">     <span class="built_in">NSArray</span>* objects = [<span class="keyword">self</span>.managedObjectContext executeFetchRequest:request error:<span class="literal">NULL</span>];</span><br><span class="line"></span><br><span class="line">     Item* rootItem = [objects lastObject];</span><br><span class="line"></span><br><span class="line">     <span class="keyword">if</span> (rootItem == <span class="literal">nil</span>) &#123;</span><br><span class="line"></span><br><span class="line">          rootItem = [Item insertItemWithTitle:<span class="literal">nil</span></span><br><span class="line"></span><br><span class="line">               parent:<span class="literal">nil</span></span><br><span class="line"></span><br><span class="line">               inManagedObjectContext:<span class="keyword">self</span>.managedObjectContext];</span><br><span class="line"></span><br><span class="line">     &#125;</span><br><span class="line"></span><br><span class="line">     <span class="keyword">return</span> rootItem;</span><br><span class="line"></span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="comment">//增加一个item</span></span><br><span class="line"></span><br><span class="line">+ (<span class="keyword">instancetype</span>)insertItemWithTitle:(<span class="built_in">NSString</span>*)title</span><br><span class="line"></span><br><span class="line">     parent:(Item*)parent</span><br><span class="line"></span><br><span class="line">     inManagedObjectContext:(<span class="built_in">NSManagedObjectContext</span> *)managedObjectContext</span><br><span class="line"></span><br><span class="line">&#123;</span><br><span class="line"></span><br><span class="line">     <span class="built_in">NSUInteger</span> order = parent.numberOfChildren;</span><br><span class="line"></span><br><span class="line">     Item* item = [<span class="built_in">NSEntityDescription</span> insertNewObjectForEntityForName:<span class="keyword">self</span>.entityName</span><br><span class="line"></span><br><span class="line">          inManagedObjectContext:managedObjectContext];</span><br><span class="line"></span><br><span class="line">     item.title = title;</span><br><span class="line"></span><br><span class="line">     item.parent = parent;</span><br><span class="line"></span><br><span class="line">     item.order = @(order);</span><br><span class="line"></span><br><span class="line">     <span class="keyword">return</span> item;</span><br><span class="line"></span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="comment">//获得子节点数量</span></span><br><span class="line"></span><br><span class="line">- (<span class="built_in">NSUInteger</span>)numberOfChildren</span><br><span class="line"></span><br><span class="line">&#123;</span><br><span class="line"></span><br><span class="line">     <span class="keyword">return</span> <span class="keyword">self</span>.children.count;</span><br><span class="line"></span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="comment">//创建一个fetched results controller的方法方便自动更新table view</span></span><br><span class="line"></span><br><span class="line">- (<span class="built_in">NSFetchedResultsController</span>*)childrenFetchedResultsController</span><br><span class="line"></span><br><span class="line">&#123;</span><br><span class="line"></span><br><span class="line">     <span class="built_in">NSFetchRequest</span>* request = [<span class="built_in">NSFetchRequest</span> fetchRequestWithEntityName:[<span class="keyword">self</span>.class entityName]];</span><br><span class="line"></span><br><span class="line">     request.predicate = [<span class="built_in">NSPredicate</span> predicateWithFormat:<span class="string">@&quot;parent = %@&quot;</span>, <span class="keyword">self</span>];</span><br><span class="line"></span><br><span class="line">     request.sortDescriptors = @[[<span class="built_in">NSSortDescriptor</span> sortDescriptorWithKey:<span class="string">@&quot;order&quot;</span> ascending:<span class="literal">YES</span>]];</span><br><span class="line"></span><br><span class="line">     <span class="keyword">return</span> [[<span class="built_in">NSFetchedResultsController</span> alloc] initWithFetchRequest:request</span><br><span class="line"></span><br><span class="line">          managedObjectContext:<span class="keyword">self</span>.managedObjectContext</span><br><span class="line"></span><br><span class="line">          sectionNameKeyPath:<span class="literal">nil</span></span><br><span class="line"></span><br><span class="line">          cacheName:<span class="literal">nil</span>];</span><br><span class="line"></span><br><span class="line">&#125;</span><br><span class="line"></span><br></pre></td></tr></table></figure>

<h1 id="和Table-View无缝结合"><a href="#和Table-View无缝结合" class="headerlink" title="和Table View无缝结合"></a>和Table View无缝结合</h1><h2 id="创建一个NSFetchedResultsController作为table-view的data-source"><a href="#创建一个NSFetchedResultsController作为table-view的data-source" class="headerlink" title="创建一个NSFetchedResultsController作为table view的data source"></a>创建一个NSFetchedResultsController作为table view的data source</h2><figure class="highlight objc"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br></pre></td><td class="code"><pre><span class="line"></span><br><span class="line">- (<span class="type">id</span>)initWithTableView:(<span class="built_in">UITableView</span>*)tableView</span><br><span class="line"></span><br><span class="line">&#123;</span><br><span class="line"></span><br><span class="line">     <span class="keyword">self</span> = [<span class="variable language_">super</span> init];</span><br><span class="line"></span><br><span class="line">     <span class="keyword">if</span> (<span class="keyword">self</span>) &#123;</span><br><span class="line"></span><br><span class="line">          <span class="keyword">self</span>.tableView = tableView;</span><br><span class="line"></span><br><span class="line">          <span class="keyword">self</span>.tableView.dataSource = <span class="keyword">self</span>;</span><br><span class="line"></span><br><span class="line">     &#125;</span><br><span class="line"></span><br><span class="line">     <span class="keyword">return</span> <span class="keyword">self</span>;</span><br><span class="line"></span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">- (<span class="type">void</span>)setFetchedResultsController:(<span class="built_in">NSFetchedResultsController</span>*)fetchedResultsController</span><br><span class="line"></span><br><span class="line">&#123;</span><br><span class="line"></span><br><span class="line">     _fetchedResultsController = fetchedResultsController;</span><br><span class="line"></span><br><span class="line">     fetchedResultsController.delegate = <span class="keyword">self</span>;</span><br><span class="line"></span><br><span class="line">     [fetchedResultsController performFetch:<span class="literal">NULL</span>];</span><br><span class="line"></span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">- (<span class="built_in">NSInteger</span>)numberOfSectionsInTableView:(<span class="built_in">UITableView</span>*)tableView</span><br><span class="line"></span><br><span class="line">&#123;</span><br><span class="line"></span><br><span class="line">     <span class="keyword">return</span> <span class="keyword">self</span>.fetchedResultsController.sections.count;</span><br><span class="line"></span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">- (<span class="built_in">NSInteger</span>)tableView:(<span class="built_in">UITableView</span>*)tableView numberOfRowsInSection:(<span class="built_in">NSInteger</span>)sectionIndex</span><br><span class="line"></span><br><span class="line">&#123;</span><br><span class="line"></span><br><span class="line">     <span class="type">id</span>&lt;<span class="built_in">NSFetchedResultsSectionInfo</span>&gt; section = <span class="keyword">self</span>.fetchedResultsController.sections[sectionIndex];</span><br><span class="line"></span><br><span class="line">     <span class="keyword">return</span> section.numberOfObjects;</span><br><span class="line"></span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">- (<span class="built_in">UITableViewCell</span>*)tableView:(<span class="built_in">UITableView</span>*)tableView</span><br><span class="line"></span><br><span class="line">cellForRowAtIndexPath:(<span class="built_in">NSIndexPath</span>*)indexPath</span><br><span class="line"></span><br><span class="line">&#123;</span><br><span class="line"></span><br><span class="line">     <span class="type">id</span> object = [<span class="keyword">self</span>.fetchedResultsController objectAtIndexPath:indexPath];</span><br><span class="line"></span><br><span class="line">     <span class="type">id</span> cell = [tableView dequeueReusableCellWithIdentifier:<span class="keyword">self</span>.reuseIdentifier</span><br><span class="line"></span><br><span class="line">          forIndexPath:indexPath];</span><br><span class="line"></span><br><span class="line">     [<span class="keyword">self</span>.delegate configureCell:cell withObject:object];</span><br><span class="line"></span><br><span class="line">     <span class="keyword">return</span> cell;</span><br><span class="line"></span><br><span class="line">&#125;</span><br><span class="line"></span><br></pre></td></tr></table></figure>

<h2 id="创建Table-View-Controller"><a href="#创建Table-View-Controller" class="headerlink" title="创建Table View Controller"></a>创建Table View Controller</h2><p>在新建的Table view的viewDidLoad里写：</p>
<figure class="highlight objc"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line">fetchedResultsControllerDataSource = [[FetchedResultsControllerDataSource alloc] initWithTableView:<span class="keyword">self</span>.tableView];</span><br><span class="line"></span><br><span class="line"><span class="keyword">self</span>.fetchedResultsControllerDataSource.fetchedResultsController = <span class="keyword">self</span>.parent.childrenFetchedResultsController;</span><br><span class="line"></span><br><span class="line">fetchedResultsControllerDataSource.delegate = <span class="keyword">self</span>;</span><br><span class="line"></span><br><span class="line">fetchedResultsControllerDataSource.reuseIdentifier = <span class="string">@&quot;Cell&quot;</span>;</span><br><span class="line"></span><br></pre></td></tr></table></figure>

<p>实现delegate</p>
<figure class="highlight objc"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br></pre></td><td class="code"><pre><span class="line">- (<span class="type">void</span>)configureCell:(<span class="type">id</span>)theCell withObject:(<span class="type">id</span>)object</span><br><span class="line"></span><br><span class="line">&#123;</span><br><span class="line"></span><br><span class="line">     <span class="built_in">UITableViewCell</span>* cell = theCell;</span><br><span class="line"></span><br><span class="line">     Item* item = object;</span><br><span class="line"></span><br><span class="line">     cell.textLabel.text = item.title;</span><br><span class="line"></span><br><span class="line">&#125;</span><br><span class="line"></span><br></pre></td></tr></table></figure>

<h2 id="添加在textFieldShouldReturn：里"><a href="#添加在textFieldShouldReturn：里" class="headerlink" title="添加在textFieldShouldReturn：里"></a>添加在textFieldShouldReturn：里</h2><figure class="highlight objc"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><span class="line">[Item insertItemWithTitle:title</span><br><span class="line"></span><br><span class="line">          parent:<span class="keyword">self</span>.parent</span><br><span class="line"></span><br><span class="line">          inManagedObjectContext:<span class="keyword">self</span>.parent.managedObjectContext];</span><br><span class="line"></span><br><span class="line">     textField.text = <span class="string">@&quot;&quot;</span>;</span><br><span class="line"></span><br><span class="line">     [textField resignFirstResponder];</span><br><span class="line"></span><br></pre></td></tr></table></figure>

<h2 id="增删改后table-view也会更改显示"><a href="#增删改后table-view也会更改显示" class="headerlink" title="增删改后table view也会更改显示"></a>增删改后table view也会更改显示</h2><figure class="highlight objc"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br></pre></td><td class="code"><pre><span class="line"></span><br><span class="line">- (<span class="type">void</span>)controller:(<span class="built_in">NSFetchedResultsController</span>*)controller</span><br><span class="line"></span><br><span class="line">     didChangeObject:(<span class="type">id</span>)anObject</span><br><span class="line"></span><br><span class="line">     atIndexPath:(<span class="built_in">NSIndexPath</span>*)indexPath</span><br><span class="line"></span><br><span class="line">     forChangeType:(<span class="built_in">NSFetchedResultsChangeType</span>)type</span><br><span class="line"></span><br><span class="line">     newIndexPath:(<span class="built_in">NSIndexPath</span>*)newIndexPath</span><br><span class="line"></span><br><span class="line">&#123;</span><br><span class="line"></span><br><span class="line">     <span class="keyword">if</span> (type == <span class="built_in">NSFetchedResultsChangeInsert</span>) &#123;</span><br><span class="line"></span><br><span class="line">          [<span class="keyword">self</span>.tableView insertRowsAtIndexPaths:@[newIndexPath]</span><br><span class="line"></span><br><span class="line">               withRowAnimation:<span class="built_in">UITableViewRowAnimationAutomatic</span>];</span><br><span class="line"></span><br><span class="line">     &#125;</span><br><span class="line"></span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">- (<span class="type">void</span>)controllerWillChangeContent:(<span class="built_in">NSFetchedResultsController</span>*)controller</span><br><span class="line"></span><br><span class="line">&#123;</span><br><span class="line"></span><br><span class="line">     [<span class="keyword">self</span>.tableView beginUpdates];</span><br><span class="line"></span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">- (<span class="type">void</span>)controllerDidChangeContent:(<span class="built_in">NSFetchedResultsController</span>*)controller</span><br><span class="line"></span><br><span class="line">&#123;</span><br><span class="line"></span><br><span class="line">     [<span class="keyword">self</span>.tableView endUpdates];</span><br><span class="line"></span><br><span class="line">&#125;</span><br><span class="line"></span><br></pre></td></tr></table></figure>

<h1 id="和Collection-View的结合"><a href="#和Collection-View的结合" class="headerlink" title="和Collection View的结合"></a>和Collection View的结合</h1><p>范例：<a target="_blank" rel="noopener" href="https://github.com/AshFurrow/UICollectionView-NSFetchedResultsController">https://github.com/AshFurrow/UICollectionView-NSFetchedResultsController</a> collection view没有beginUpdates和endUpdates方法，所以只能用performBatchUpdate方法收集所有更新，然后在controllerDidChangeContent中用block执行所有更新。</p>
<h1 id="如何传递Table-view里的Model对象到新的view-controller中"><a href="#如何传递Table-view里的Model对象到新的view-controller中" class="headerlink" title="如何传递Table view里的Model对象到新的view controller中"></a>如何传递Table view里的Model对象到新的view controller中</h1><figure class="highlight objc"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br></pre></td><td class="code"><pre><span class="line"></span><br><span class="line">- (<span class="type">void</span>)prepareForSegue:(<span class="built_in">UIStoryboardSegue</span>*)segue sender:(<span class="type">id</span>)sender</span><br><span class="line"></span><br><span class="line">&#123;</span><br><span class="line"></span><br><span class="line">     [<span class="variable language_">super</span> prepareForSegue:segue sender:sender];</span><br><span class="line"></span><br><span class="line">     <span class="keyword">if</span> ([segue.identifier isEqualToString:selectItemSegue]) &#123;</span><br><span class="line"></span><br><span class="line">          [<span class="keyword">self</span> presentSubItemViewController:segue.destinationViewController];</span><br><span class="line"></span><br><span class="line">     &#125;</span><br><span class="line"></span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">- (<span class="type">void</span>)presentSubItemViewController:(ItemViewController*)subItemViewController</span><br><span class="line"></span><br><span class="line">&#123;</span><br><span class="line"></span><br><span class="line">     Item* item = [<span class="keyword">self</span>.fetchedResultsControllerDataSource selectedItem];</span><br><span class="line"></span><br><span class="line">     subItemViewController.parent = item;</span><br><span class="line"></span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">- (<span class="type">void</span>)viewWillAppear:(<span class="type">BOOL</span>)animated</span><br><span class="line"></span><br><span class="line">&#123;</span><br><span class="line"></span><br><span class="line">     [<span class="variable language_">super</span> viewWillAppear:animated];</span><br><span class="line"></span><br><span class="line">     <span class="keyword">self</span>.fetchedResultsControllerDataSource.paused = <span class="literal">NO</span>;</span><br><span class="line"></span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">- (<span class="type">void</span>)viewWillDisappear:(<span class="type">BOOL</span>)animated</span><br><span class="line"></span><br><span class="line">&#123;</span><br><span class="line"></span><br><span class="line">     [<span class="variable language_">super</span> viewWillDisappear:animated];</span><br><span class="line"></span><br><span class="line">     <span class="keyword">self</span>.fetchedResultsControllerDataSource.paused = <span class="literal">YES</span>;</span><br><span class="line"></span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">- (<span class="type">void</span>)setPaused:(<span class="type">BOOL</span>)paused</span><br><span class="line"></span><br><span class="line">&#123;</span><br><span class="line"></span><br><span class="line">     _paused = paused;</span><br><span class="line"></span><br><span class="line">     <span class="keyword">if</span> (paused) &#123;</span><br><span class="line"></span><br><span class="line">          <span class="keyword">self</span>.fetchedResultsController.delegate = <span class="literal">nil</span>;</span><br><span class="line"></span><br><span class="line">     &#125; <span class="keyword">else</span> &#123;</span><br><span class="line"></span><br><span class="line">          <span class="keyword">self</span>.fetchedResultsController.delegate = <span class="keyword">self</span>;</span><br><span class="line"></span><br><span class="line">          [<span class="keyword">self</span>.fetchedResultsController performFetch:<span class="literal">NULL</span>];</span><br><span class="line"></span><br><span class="line">          [<span class="keyword">self</span>.tableView reloadData];</span><br><span class="line"></span><br><span class="line">     &#125;</span><br><span class="line"></span><br><span class="line">&#125;</span><br><span class="line"></span><br></pre></td></tr></table></figure>

<h1 id="删除"><a href="#删除" class="headerlink" title="删除"></a>删除</h1><figure class="highlight objc"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br></pre></td><td class="code"><pre><span class="line"></span><br><span class="line"><span class="comment">//让table view支持滑动删除</span></span><br><span class="line"></span><br><span class="line">- (<span class="type">BOOL</span>)tableView:(<span class="built_in">UITableView</span>*)tableView</span><br><span class="line"></span><br><span class="line">canEditRowAtIndexPath:(<span class="built_in">NSIndexPath</span>*)indexPath</span><br><span class="line"></span><br><span class="line">&#123;</span><br><span class="line"></span><br><span class="line">     <span class="keyword">return</span> <span class="literal">YES</span>;</span><br><span class="line"></span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">- (<span class="type">void</span>)tableView:(<span class="built_in">UITableView</span> *)tableView</span><br><span class="line"></span><br><span class="line">     commitEditingStyle:(<span class="built_in">UITableViewCellEditingStyle</span>)editingStyle</span><br><span class="line"></span><br><span class="line">     forRowAtIndexPath:(<span class="built_in">NSIndexPath</span> *)indexPath &#123;</span><br><span class="line"></span><br><span class="line">     <span class="keyword">if</span> (editingStyle == <span class="built_in">UITableViewCellEditingStyleDelete</span>) &#123;</span><br><span class="line"></span><br><span class="line">          <span class="type">id</span> object = [<span class="keyword">self</span>.fetchedResultsController objectAtIndexPath:indexPath];</span><br><span class="line"></span><br><span class="line">          [<span class="keyword">self</span>.delegate deleteObject:object];</span><br><span class="line"></span><br><span class="line">     &#125;</span><br><span class="line"></span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="comment">//强制order变化，可以重写prepareForDeletion方法</span></span><br><span class="line"></span><br><span class="line">- (<span class="type">void</span>)prepareForDeletion</span><br><span class="line"></span><br><span class="line">&#123;</span><br><span class="line"></span><br><span class="line">     <span class="built_in">NSSet</span>* siblings = <span class="keyword">self</span>.parent.children;</span><br><span class="line"></span><br><span class="line">     <span class="built_in">NSPredicate</span>* predicate = [<span class="built_in">NSPredicate</span> predicateWithFormat:<span class="string">@&quot;order &gt; %@&quot;</span>, <span class="keyword">self</span>.order];</span><br><span class="line"></span><br><span class="line">     <span class="built_in">NSSet</span>* siblingsAfterSelf = [siblings filteredSetUsingPredicate:predicate];</span><br><span class="line"></span><br><span class="line">     [siblingsAfterSelf enumerateObjectsUsingBlock:^(Item* sibling, <span class="type">BOOL</span>* stop)</span><br><span class="line"></span><br><span class="line">     &#123;</span><br><span class="line"></span><br><span class="line">          sibling.order = @(sibling.order.integerValue - <span class="number">1</span>);</span><br><span class="line"></span><br><span class="line">     &#125;];</span><br><span class="line"></span><br><span class="line">&#125;</span><br><span class="line"></span><br></pre></td></tr></table></figure>

<p>增加删除的动画效果</p>
<figure class="highlight objc"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line"></span><br><span class="line"><span class="keyword">else</span> <span class="keyword">if</span> (type == <span class="built_in">NSFetchedResultsChangeDelete</span>) &#123;</span><br><span class="line"></span><br><span class="line">     [<span class="keyword">self</span>.tableView deleteRowsAtIndexPaths:@[indexPath]</span><br><span class="line"></span><br><span class="line">          withRowAnimation:<span class="built_in">UITableViewRowAnimationAutomatic</span>];</span><br><span class="line"></span><br><span class="line">&#125;</span><br><span class="line"></span><br></pre></td></tr></table></figure>

<p>增加晃动撤销功能</p>
<figure class="highlight objc"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">//第一步告诉application支持这个</span></span><br><span class="line"></span><br><span class="line">application.applicationSupportsShakeToEdit = <span class="literal">YES</span>;</span><br><span class="line"></span><br><span class="line"><span class="comment">//重写UIResponder类中的两个方法</span></span><br><span class="line"></span><br><span class="line">- (<span class="type">BOOL</span>)canBecomeFirstResponder &#123;</span><br><span class="line"></span><br><span class="line">     <span class="keyword">return</span> <span class="literal">YES</span>;</span><br><span class="line"></span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">- (<span class="built_in">NSUndoManager</span>*)undoManager</span><br><span class="line"></span><br><span class="line">&#123;</span><br><span class="line"></span><br><span class="line">     <span class="keyword">return</span> <span class="keyword">self</span>.managedObjectContext.undoManager;</span><br><span class="line"></span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="comment">//在持续化stack中设置一个undo manager</span></span><br><span class="line"></span><br><span class="line"><span class="keyword">self</span>.managedObjectContext.undoManager = [[<span class="built_in">NSUndoManager</span> alloc] init];</span><br><span class="line"></span><br><span class="line"><span class="comment">//实现上面几步后晃动时会得到两个按钮的提醒框，可以给让用户体验更加友好些</span></span><br><span class="line"></span><br><span class="line"><span class="built_in">NSString</span>* title = textField.text;</span><br><span class="line"></span><br><span class="line"><span class="built_in">NSString</span>* actionName = [<span class="built_in">NSString</span> stringWithFormat:<span class="built_in">NSLocalizedString</span>(<span class="string">@&quot;add item \&quot;%@\&quot;&quot;</span>, <span class="string">@&quot;Undo action name of add item&quot;</span>), title];</span><br><span class="line"></span><br><span class="line">[<span class="keyword">self</span>.undoManager setActionName:actionName];</span><br><span class="line"></span><br><span class="line">[<span class="keyword">self</span>.store addItem:title parent:<span class="literal">nil</span>];</span><br><span class="line"></span><br></pre></td></tr></table></figure>

<h1 id="排序"><a href="#排序" class="headerlink" title="排序"></a>排序</h1><p>可以参考官方文档：<a target="_blank" rel="noopener" href="https://developer.apple.com/library/ios/documentation/CoreData/Reference/NSFetchedResultsControllerDelegate_Protocol/Reference/Reference.html#//apple_ref/doc/uid/TP40008228-CH1-SW14">https://developer.apple.com/library/ios/documentation/CoreData/Reference/NSFetchedResultsControllerDelegate_Protocol&#x2F;Reference&#x2F;Reference.html#&#x2F;&#x2F;apple_ref&#x2F;doc&#x2F;uid&#x2F;TP40008228-CH1-SW14</a></p>
<h1 id="保存"><a href="#保存" class="headerlink" title="保存"></a>保存</h1><ul>
<li>保存是在managed object context中调用save。可以在applicationWillTerminate:中执行，也可能在applicationDIdEnterBackground:中。</li>
<li>异步存储Core Data 网络应用实例：（中文）<a target="_blank" rel="noopener" href="http://objccn.io/issue-10-5/">http://objccn.io/issue-10-5/</a> （英文）<a target="_blank" rel="noopener" href="http://www.objc.io/issue-10/networked-core-data-application.html">http://www.objc.io/issue-10/networked-core-data-application.html</a></li>
</ul>
<h1 id="Fetch获取对象"><a href="#Fetch获取对象" class="headerlink" title="Fetch获取对象"></a>Fetch获取对象</h1><h2 id="基础"><a href="#基础" class="headerlink" title="基础"></a>基础</h2><p>官方文档：<a target="_blank" rel="noopener" href="https://developer.apple.com/library/mac/documentation/Cocoa/Conceptual/CoreData/Articles/cdFetching.html">https://developer.apple.com/library/mac/documentation/Cocoa/Conceptual/CoreData/Articles/cdFetching.html</a></p>
<h2 id="范例"><a href="#范例" class="headerlink" title="范例"></a>范例</h2><figure class="highlight objc"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br></pre></td><td class="code"><pre><span class="line"></span><br><span class="line">request.result = [<span class="built_in">NSPredicate</span> predicateWithFormat:</span><br><span class="line"></span><br><span class="line">     <span class="string">@&quot;(%@ &lt;= longitude) AND (longitude &lt;= %@)&quot;</span></span><br><span class="line"></span><br><span class="line">     <span class="string">@&quot;AND (%@ &lt;= latitude) AND (latitude &lt;= %@)&quot;</span>,</span><br><span class="line"></span><br><span class="line">     @(minLongitude), @(maxLongitude), @(minLatitude), @(maxLatitude)];</span><br><span class="line"></span><br><span class="line"><span class="comment">//取消将值放到row cache中。</span></span><br><span class="line"></span><br><span class="line">request.returnsObjectsAsFaults = <span class="literal">NO</span>;</span><br><span class="line"></span><br><span class="line">request.fetchLimit = <span class="number">200</span>;</span><br><span class="line"></span><br><span class="line"><span class="comment">//执行fetch</span></span><br><span class="line"></span><br><span class="line"><span class="built_in">NSError</span> *error = <span class="literal">nil</span>;</span><br><span class="line"></span><br><span class="line"><span class="built_in">NSArray</span> *stops = [moc executeFetchRequest:request error:&amp;error];</span><br><span class="line"></span><br><span class="line"><span class="built_in">NSAssert</span>(stops != <span class="literal">nil</span>, <span class="string">@&quot;Failed to execute %@: %@&quot;</span>, request, error);</span><br><span class="line"></span><br><span class="line"><span class="comment">//二次遍历</span></span><br><span class="line"></span><br><span class="line"><span class="built_in">NSPredicate</span> *exactPredicate = [<span class="keyword">self</span> exactLatitudeAndLongitudePredicateForCoordinate:<span class="keyword">self</span>.location.coordinate];</span><br><span class="line"></span><br><span class="line">stops = [stops filteredArrayUsingPredicate:exactPredicate];</span><br><span class="line"></span><br><span class="line">- (<span class="built_in">NSPredicate</span> *)exactLatitudeAndLongitudePredicateForCoordinate:(<span class="built_in">CLLocationCoordinate2D</span>)pointOfInterest;</span><br><span class="line"></span><br><span class="line">&#123;</span><br><span class="line"></span><br><span class="line">     <span class="keyword">return</span> [<span class="built_in">NSPredicate</span> predicateWithBlock:^<span class="type">BOOL</span>(Stop *evaluatedStop, <span class="built_in">NSDictionary</span> *bindings) &#123;</span><br><span class="line"></span><br><span class="line">          <span class="built_in">CLLocation</span> *evaluatedLocation = [[<span class="built_in">CLLocation</span> alloc] initWithLatitude:evaluatedStop.latitude           longitude:evaluatedStop.longitude];</span><br><span class="line"></span><br><span class="line">          <span class="built_in">CLLocationDistance</span> distance = [<span class="keyword">self</span>.location distanceFromLocation:evaluatedLocation];</span><br><span class="line"></span><br><span class="line">          <span class="keyword">return</span> (distance &lt; <span class="keyword">self</span>.distance);</span><br><span class="line"></span><br><span class="line">     &#125;];</span><br><span class="line"></span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="comment">//子查询</span></span><br><span class="line"></span><br><span class="line"><span class="built_in">NSPredicate</span> *timePredicate = [<span class="built_in">NSPredicate</span> predicateWithFormat:<span class="string">@&quot;(%@ &lt;= departureTime) &amp;&amp; (departureTime &lt;= %@)”, startDate, endDate];</span></span><br><span class="line"><span class="string"></span></span><br><span class="line"><span class="string">NSPredicate *predicate = [NSPredicate predicateWithFormat:</span></span><br><span class="line"><span class="string"></span></span><br><span class="line"><span class="string">     @&quot;</span>(SUBQUERY(stopTimes, $x, (%@ &lt;= $x.departureTime) &amp;&amp; ($x.departureTime &lt;= %@)).@count != <span class="number">0</span>)”, startDate, endDate];</span><br><span class="line"></span><br><span class="line"><span class="comment">//文本搜索</span></span><br><span class="line"></span><br><span class="line"><span class="built_in">NSString</span> *searchString = <span class="string">@&quot;U Görli&quot;</span>;</span><br><span class="line"></span><br><span class="line">predicate = [<span class="built_in">NSPredicate</span> predicateWithFormat:<span class="string">@&quot;name BEGINSWITH %@&quot;</span>, searchString];</span><br><span class="line"></span><br></pre></td></tr></table></figure>

<h1 id="导入大量数据"><a href="#导入大量数据" class="headerlink" title="导入大量数据"></a>导入大量数据</h1><h2 id="应用Bundle里的SQLite文件"><a href="#应用Bundle里的SQLite文件" class="headerlink" title="应用Bundle里的SQLite文件"></a>应用Bundle里的SQLite文件</h2><figure class="highlight objc"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br></pre></td><td class="code"><pre><span class="line"><span class="built_in">NSFileManager</span>* fileManager = [<span class="built_in">NSFileManager</span> defaultManager];</span><br><span class="line"></span><br><span class="line"><span class="built_in">NSError</span> *error;</span><br><span class="line"></span><br><span class="line"><span class="keyword">if</span>([fileManager fileExistsAtPath:<span class="keyword">self</span>.storeURL.path]) &#123;</span><br><span class="line"></span><br><span class="line">     <span class="built_in">NSURL</span> *storeDirectory = [<span class="keyword">self</span>.storeURL URLByDeletingLastPathComponent];</span><br><span class="line"></span><br><span class="line">     <span class="built_in">NSDirectoryEnumerator</span> *enumerator = [fileManager enumeratorAtURL:storeDirectory</span><br><span class="line"></span><br><span class="line">          includingPropertiesForKeys:<span class="literal">nil</span></span><br><span class="line"></span><br><span class="line">          options:<span class="number">0</span></span><br><span class="line"></span><br><span class="line">          errorHandler:<span class="literal">NULL</span>];</span><br><span class="line"></span><br><span class="line">     <span class="built_in">NSString</span> *storeName = [<span class="keyword">self</span>.storeURL.lastPathComponent stringByDeletingPathExtension];</span><br><span class="line"></span><br><span class="line">     <span class="comment">//遍历目录下是否有重复</span></span><br><span class="line"></span><br><span class="line">     <span class="keyword">for</span> (<span class="built_in">NSURL</span> *url <span class="keyword">in</span> enumerator) &#123;</span><br><span class="line"></span><br><span class="line">          <span class="keyword">if</span> (![url.lastPathComponent hasPrefix:storeName]) <span class="keyword">continue</span>;</span><br><span class="line"></span><br><span class="line">          [fileManager removeItemAtURL:url error:&amp;error];</span><br><span class="line"></span><br><span class="line">     &#125;</span><br><span class="line"></span><br><span class="line">      <span class="comment">// 处理错误</span></span><br><span class="line"></span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="built_in">NSString</span>* bundleDbPath = [[<span class="built_in">NSBundle</span> mainBundle] pathForResource:<span class="string">@&quot;seed&quot;</span> ofType:<span class="string">@&quot;sqlite&quot;</span>];</span><br><span class="line"></span><br><span class="line">[fileManager copyItemAtPath:bundleDbPath toPath:<span class="keyword">self</span>.storeURL.path error:&amp;error];</span><br><span class="line"></span><br><span class="line"><span class="comment">//真机删除会失效，所以使用版本号来进行区分新旧</span></span><br><span class="line"></span><br><span class="line"><span class="built_in">NSString</span>* bundleVersion = [infoDictionary objectForKey:(<span class="built_in">NSString</span> *)kCFBundleVersionKey];</span><br><span class="line"></span><br><span class="line"><span class="built_in">NSString</span> *seedVersion = [[<span class="built_in">NSUserDefaults</span> standardUserDefaults] objectForKey<span class="string">@&quot;SeedVersion&quot;</span>];</span><br><span class="line"></span><br><span class="line"><span class="keyword">if</span> (![seedVersion isEqualToString:bundleVersion]) &#123;</span><br><span class="line"></span><br><span class="line">     <span class="comment">// 复制源数据库</span></span><br><span class="line"></span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="comment">// ... 导入成功后</span></span><br><span class="line"></span><br><span class="line"><span class="built_in">NSDictionary</span> *infoDictionary = [<span class="built_in">NSBundle</span> mainBundle].infoDictionary;</span><br><span class="line"></span><br><span class="line">[[<span class="built_in">NSUserDefaults</span> standardUserDefaults] setObject:bundleVersion forKey:<span class="string">@&quot;SeedVersion&quot;</span>];</span><br><span class="line"></span><br></pre></td></tr></table></figure>

<h2 id="导入范例"><a href="#导入范例" class="headerlink" title="导入范例"></a>导入范例</h2><p><a target="_blank" rel="noopener" href="https://github.com/objcio/issue-4-importing-and-fetching">https://github.com/objcio/issue-4-importing-and-fetching</a></p>
<h1 id="版本迁移"><a href="#版本迁移" class="headerlink" title="版本迁移"></a>版本迁移</h1><h2 id="Mapping-Models"><a href="#Mapping-Models" class="headerlink" title="Mapping Models"></a>Mapping Models</h2><p>NSMigrationManager能够推断两个版本模型的映射关系，但是如果版本跨度大了就力不从心了。</p>
<h2 id="Progressive-Migrations渐进式迁移"><a href="#Progressive-Migrations渐进式迁移" class="headerlink" title="Progressive Migrations渐进式迁移"></a>Progressive Migrations渐进式迁移</h2><p>实现原理是两个版本之间确保正常，升级时按照一个版本一个版本渐进式的升级方式，比如最新的版本是第四版，如果用户使用的是第二版的，那么升级是就是先从第二版升级到第三版，然后再从第三版升级到第四版。完整范例：<a target="_blank" rel="noopener" href="https://github.com/objcio/issue-4-core-data-migration">https://github.com/objcio/issue-4-core-data-migration</a> 主要代码来自Marcus Zarra<a target="_blank" rel="noopener" href="https://twitter.com/mzarra">https://twitter.com/mzarra</a> ，他的书关于Core Data的值得一看，<a target="_blank" rel="noopener" href="http://pragprog.com/book/mzcd2/core-data">http://pragprog.com/book/mzcd2/core-data</a></p>
<h2 id="迁移策略"><a href="#迁移策略" class="headerlink" title="迁移策略"></a>迁移策略</h2><p>NSEntityMigrationPolicy这个类不光能够修改Entity的属性和关系，还能够自定义一些操作完成每个Entity的迁移。例如在Entity Mapping的Custom Polity里写上自定义的polity的方法</p>
<figure class="highlight objc"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br></pre></td><td class="code"><pre><span class="line"><span class="built_in">NSNumber</span> *modelVersion = [mapping.userInfo valueForKey:<span class="string">@&quot;modelVersion&quot;</span>];</span><br><span class="line"></span><br><span class="line"><span class="keyword">if</span> (modelVersion.integerValue == <span class="number">2</span>) &#123;</span><br><span class="line"></span><br><span class="line">     <span class="built_in">NSMutableArray</span> *sourceKeys = [sourceInstance.entity.attributesByName.allKeys mutableCopy];</span><br><span class="line"></span><br><span class="line">     <span class="built_in">NSDictionary</span> *sourceValues = [sourceInstance dictionaryWithValuesForKeys:sourceKeys];</span><br><span class="line"></span><br><span class="line">     <span class="built_in">NSManagedObject</span> *destinationInstance = [<span class="built_in">NSEntityDescription</span> insertNewObjectForEntityForName:mapping.destinationEntityName</span><br><span class="line"></span><br><span class="line">          inManagedObjectContext:manager.destinationContext];</span><br><span class="line"></span><br><span class="line">     <span class="built_in">NSArray</span> *destinationKeys = destinationInstance.entity.attributesByName.allKeys;</span><br><span class="line"></span><br><span class="line">     <span class="keyword">for</span> (<span class="built_in">NSString</span> *key <span class="keyword">in</span> destinationKeys) &#123;</span><br><span class="line"></span><br><span class="line">          <span class="type">id</span> value = [sourceValues valueForKey:key];</span><br><span class="line"></span><br><span class="line">          <span class="comment">// 避免value为空</span></span><br><span class="line"></span><br><span class="line">          <span class="keyword">if</span> (value &amp;&amp; ![value isEqual:[<span class="built_in">NSNull</span> null]]) &#123;</span><br><span class="line"></span><br><span class="line">               [destinationInstance setValue:value forKey:key];</span><br><span class="line"></span><br><span class="line">          &#125;</span><br><span class="line"></span><br><span class="line">     &#125;</span><br><span class="line"></span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="built_in">NSMutableDictionary</span> *authorLookup = [manager lookupWithKey:<span class="string">@&quot;authors&quot;</span>];</span><br><span class="line"></span><br><span class="line"><span class="comment">// 检查该作者是否已经被创建了</span></span><br><span class="line"></span><br><span class="line"><span class="built_in">NSString</span> *authorName = [sourceInstance valueForKey:<span class="string">@&quot;author&quot;</span>];</span><br><span class="line"></span><br><span class="line"><span class="built_in">NSManagedObject</span> *author = [authorLookup valueForKey:authorName];</span><br><span class="line"></span><br><span class="line"><span class="keyword">if</span> (!author) &#123;</span><br><span class="line"></span><br><span class="line">     <span class="comment">// 创建作者</span></span><br><span class="line"></span><br><span class="line">     <span class="comment">// ...</span></span><br><span class="line"></span><br><span class="line">     <span class="comment">// 更新避免重复</span></span><br><span class="line"></span><br><span class="line">     [authorLookup setValue:author forKey:authorName];</span><br><span class="line"></span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">[destinationInstance performSelector:<span class="keyword">@selector</span>(addAuthorsObject:) withObject:author];</span><br><span class="line"></span><br><span class="line"><span class="comment">//源存储和目的存储之间的关系</span></span><br><span class="line"></span><br><span class="line">[manager associateSourceInstance:sourceInstance</span><br><span class="line"></span><br><span class="line">     withDestinationInstance:destinationInstance</span><br><span class="line"></span><br><span class="line">     forEntityMapping:mapping];</span><br><span class="line"></span><br><span class="line"><span class="keyword">return</span> <span class="literal">YES</span>;</span><br><span class="line"></span><br></pre></td></tr></table></figure>

<p>NSMigrationManager的category方法</p>
<figure class="highlight objc"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br></pre></td><td class="code"><pre><span class="line"><span class="class"><span class="keyword">@implementation</span> <span class="title">NSMigrationManager</span> (<span class="title">Lookup</span>)</span></span><br><span class="line"></span><br><span class="line">- (<span class="built_in">NSMutableDictionary</span> *)lookupWithKey:(<span class="built_in">NSString</span> *)lookupKey</span><br><span class="line"></span><br><span class="line">&#123;</span><br><span class="line"></span><br><span class="line">     <span class="built_in">NSMutableDictionary</span> *userInfo = (<span class="built_in">NSMutableDictionary</span> *)<span class="keyword">self</span>.userInfo;</span><br><span class="line"></span><br><span class="line">     <span class="comment">// 这里检查一下是否已经建立了 userInfo 的字典</span></span><br><span class="line"></span><br><span class="line">     <span class="keyword">if</span> (!userInfo) &#123;</span><br><span class="line"></span><br><span class="line">          userInfo = [@&#123;&#125; mutableCopy];</span><br><span class="line"></span><br><span class="line">          <span class="keyword">self</span>.userInfo = userInfo;</span><br><span class="line"></span><br><span class="line">     &#125;</span><br><span class="line"></span><br><span class="line">     <span class="built_in">NSMutableDictionary</span> *lookup = [userInfo valueForKey:lookupKey];</span><br><span class="line"></span><br><span class="line">     <span class="keyword">if</span> (!lookup) &#123;</span><br><span class="line"></span><br><span class="line">          lookup = [@&#123;&#125; mutableCopy];</span><br><span class="line"></span><br><span class="line">          [userInfo setValue:lookup forKey:lookupKey];</span><br><span class="line"></span><br><span class="line">     &#125;</span><br><span class="line"></span><br><span class="line">     <span class="keyword">return</span> lookup;</span><br><span class="line"></span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="keyword">@end</span></span><br><span class="line"></span><br></pre></td></tr></table></figure>

<p>更复杂的迁移</p>
<figure class="highlight objc"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br></pre></td><td class="code"><pre><span class="line"><span class="built_in">NSArray</span> *users = [sourceInstance valueForKey:<span class="string">@&quot;users&quot;</span>];</span><br><span class="line"></span><br><span class="line"><span class="keyword">for</span> (<span class="built_in">NSManagedObject</span> *user <span class="keyword">in</span> users) &#123;</span><br><span class="line"></span><br><span class="line">     <span class="built_in">NSManagedObject</span> *file = [<span class="built_in">NSEntityDescription</span> insertNewObjectForEntityForName:<span class="string">@&quot;File&quot;</span></span><br><span class="line"></span><br><span class="line">          inManagedObjectContext:manager.destinationContext];</span><br><span class="line"></span><br><span class="line">     [file setValue:[sourceInstance valueForKey:<span class="string">@&quot;fileURL&quot;</span>] forKey:<span class="string">@&quot;fileURL&quot;</span>];</span><br><span class="line"></span><br><span class="line">     [file setValue:destinationInstance forKey:<span class="string">@&quot;book&quot;</span>];</span><br><span class="line"></span><br><span class="line">     <span class="built_in">NSInteger</span> userId = [[user valueForKey:<span class="string">@&quot;userId&quot;</span>] integerValue];</span><br><span class="line"></span><br><span class="line">     <span class="built_in">NSFetchRequest</span> *request = [<span class="built_in">NSFetchRequest</span> fetchRequestWithEntityName:<span class="string">@&quot;User&quot;</span>];</span><br><span class="line"></span><br><span class="line">     request.predicate = [<span class="built_in">NSPredicate</span> predicateWithFormat:<span class="string">@&quot;userId = %d&quot;</span>, userId];</span><br><span class="line"></span><br><span class="line">     <span class="built_in">NSManagedObject</span> *user = [[manager.destinationContext executeFetchRequest:request error:<span class="literal">nil</span>] lastObject];</span><br><span class="line"></span><br><span class="line">     [file setValue:user forKey:<span class="string">@&quot;user&quot;</span>];</span><br><span class="line"></span><br><span class="line">&#125;</span><br><span class="line"></span><br></pre></td></tr></table></figure>

<p>数据量大时的迁移改造，利用CoreData提供的chunks数据块方式。官方文档<a target="_blank" rel="noopener" href="https://developer.apple.com/library/ios/documentation/cocoa/Conceptual/CoreDataVersioning/Articles/vmCustomizing.html#//apple_ref/doc/uid/TP40004399-CH8-SW9">https://developer.apple.com/library/ios/documentation/cocoa/Conceptual/CoreDataVersioning/Articles/vmCustomizing.html#//apple_ref&#x2F;doc&#x2F;uid&#x2F;TP40004399-CH8-SW9</a></p>
<figure class="highlight objc"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br></pre></td><td class="code"><pre><span class="line"><span class="built_in">NSArray</span> *mappingModels = @[mappingModel]; <span class="comment">// 我们之前建立的那个模型</span></span><br><span class="line"></span><br><span class="line"><span class="keyword">if</span> ([<span class="keyword">self</span>.delegate respondsToSelector:<span class="keyword">@selector</span>(migrationManager:mappingModelsForSourceModel:)]) &#123;</span><br><span class="line"></span><br><span class="line">     <span class="built_in">NSArray</span> *explicitMappingModels = [<span class="keyword">self</span>.delegate migrationManager:<span class="keyword">self</span></span><br><span class="line"></span><br><span class="line">          mappingModelsForSourceModel:sourceModel];</span><br><span class="line"></span><br><span class="line">     <span class="keyword">if</span> (<span class="number">0</span> &lt; explicitMappingModels.count) &#123;</span><br><span class="line"></span><br><span class="line">          mappingModels = explicitMappingModels;</span><br><span class="line"></span><br><span class="line">     &#125;</span><br><span class="line"></span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="keyword">for</span> (<span class="built_in">NSMappingModel</span> *mappingModel <span class="keyword">in</span> mappingModels) &#123;</span><br><span class="line"></span><br><span class="line">     didMigrate = [manager migrateStoreFromURL:sourceStoreURL</span><br><span class="line"></span><br><span class="line">          type:type</span><br><span class="line"></span><br><span class="line">          options:<span class="literal">nil</span></span><br><span class="line"></span><br><span class="line">          withMappingModel:mappingModel</span><br><span class="line"></span><br><span class="line">          toDestinationURL:destinationStoreURL</span><br><span class="line"></span><br><span class="line">          destinationType:type</span><br><span class="line"></span><br><span class="line">          destinationOptions:<span class="literal">nil</span></span><br><span class="line"></span><br><span class="line">          error:error];</span><br><span class="line"></span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">- (<span class="built_in">NSArray</span> *)migrationManager:(MHWMigrationManager *)migrationManager</span><br><span class="line"></span><br><span class="line">     mappingModelsForSourceModel:(<span class="built_in">NSManagedObjectModel</span> *)sourceModel</span><br><span class="line"></span><br><span class="line">&#123;</span><br><span class="line"></span><br><span class="line">     <span class="built_in">NSMutableArray</span> *mappingModels = [@[] mutableCopy];</span><br><span class="line"></span><br><span class="line">     <span class="built_in">NSString</span> *modelName = [sourceModel mhw_modelName];</span><br><span class="line"></span><br><span class="line">     <span class="keyword">if</span> ([modelName isEqual:<span class="string">@&quot;Model2&quot;</span>]) &#123;</span><br><span class="line"></span><br><span class="line">          <span class="comment">// 把该映射模型加入数组</span></span><br><span class="line"></span><br><span class="line">     &#125;</span><br><span class="line"></span><br><span class="line">     <span class="keyword">return</span> mappingModels;</span><br><span class="line"></span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">- (<span class="built_in">NSString</span> *)mhw_modelName</span><br><span class="line"></span><br><span class="line">&#123;</span><br><span class="line"></span><br><span class="line">     <span class="built_in">NSString</span> *modelName = <span class="literal">nil</span>;</span><br><span class="line"></span><br><span class="line">     <span class="built_in">NSArray</span> *modelPaths = <span class="comment">// get paths to all the mom files in the bundle</span></span><br><span class="line"></span><br><span class="line">     <span class="keyword">for</span> (<span class="built_in">NSString</span> *modelPath <span class="keyword">in</span> modelPaths) &#123;</span><br><span class="line"></span><br><span class="line">          <span class="built_in">NSURL</span> *modelURL = [<span class="built_in">NSURL</span> fileURLWithPath:modelPath];</span><br><span class="line"></span><br><span class="line">          <span class="built_in">NSManagedObjectModel</span> *model = [[<span class="built_in">NSManagedObjectModel</span> alloc] initWithContentsOfURL:modelURL];</span><br><span class="line"></span><br><span class="line">          <span class="keyword">if</span> ([model isEqual:<span class="keyword">self</span>]) &#123;</span><br><span class="line"></span><br><span class="line">               modelName = modelURL.lastPathComponent.stringByDeletingPathExtension;</span><br><span class="line"></span><br><span class="line">               <span class="keyword">break</span>;</span><br><span class="line"></span><br><span class="line">          &#125;</span><br><span class="line"></span><br><span class="line">     &#125;</span><br><span class="line"></span><br><span class="line">     <span class="keyword">return</span> modelName;</span><br><span class="line"></span><br><span class="line">&#125;</span><br><span class="line"></span><br></pre></td></tr></table></figure>

<p>建立单元测试，</p>
<figure class="highlight objc"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br></pre></td><td class="code"><pre><span class="line"></span><br><span class="line">- (<span class="type">void</span>)setUpCoreDataStackMigratingFromStoreWithName:(<span class="built_in">NSString</span> *)name</span><br><span class="line"></span><br><span class="line">&#123;</span><br><span class="line"></span><br><span class="line">     <span class="built_in">NSURL</span> *storeURL = [<span class="keyword">self</span> temporaryRandomURL];</span><br><span class="line"></span><br><span class="line">     [<span class="keyword">self</span> copyStoreWithName:name toURL:storeURL];</span><br><span class="line"></span><br><span class="line">     <span class="built_in">NSURL</span> *momURL = [[<span class="built_in">NSBundle</span> mainBundle] URLForResource:<span class="string">@&quot;Model&quot;</span> withExtension:<span class="string">@&quot;momd&quot;</span>];</span><br><span class="line"></span><br><span class="line">     <span class="keyword">self</span>.managedObjectModel = [[<span class="built_in">NSManagedObjectModel</span> alloc] initWithContentsOfURL:momURL];</span><br><span class="line"></span><br><span class="line">     <span class="built_in">NSString</span> *storeType = <span class="built_in">NSSQLiteStoreType</span>;</span><br><span class="line"></span><br><span class="line">     MHWMigrationManager *migrationManager = [MHWMigrationManager new];</span><br><span class="line"></span><br><span class="line">     [migrationManager progressivelyMigrateURL:storeURL</span><br><span class="line"></span><br><span class="line">          ofType:storeType</span><br><span class="line"></span><br><span class="line">          toModel:<span class="keyword">self</span>.managedObjectModel</span><br><span class="line"></span><br><span class="line">          error:<span class="literal">nil</span>];</span><br><span class="line"></span><br><span class="line">     <span class="keyword">self</span>.persistentStoreCoordinator = [[<span class="built_in">NSPersistentStoreCoordinator</span> alloc] initWithManagedObjectModel:<span class="keyword">self</span>.managedObjectModel];</span><br><span class="line"></span><br><span class="line">     [<span class="keyword">self</span>.persistentStoreCoordinator addPersistentStoreWithType:storeType</span><br><span class="line"></span><br><span class="line">          configuration:<span class="literal">nil</span></span><br><span class="line"></span><br><span class="line">          URL:storeURL</span><br><span class="line"></span><br><span class="line">          options:<span class="literal">nil</span></span><br><span class="line"></span><br><span class="line">          error:<span class="literal">nil</span>];</span><br><span class="line"></span><br><span class="line">     <span class="keyword">self</span>.managedObjectContext = [[<span class="built_in">NSManagedObjectContext</span> alloc] init];</span><br><span class="line"></span><br><span class="line">     <span class="keyword">self</span>.managedObjectContext.persistentStoreCoordinator = <span class="keyword">self</span>.persistentStoreCoordinator;</span><br><span class="line"></span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">- (<span class="built_in">NSURL</span> *)temporaryRandomURL</span><br><span class="line"></span><br><span class="line">&#123;</span><br><span class="line"></span><br><span class="line">     <span class="built_in">NSString</span> *uniqueName = [<span class="built_in">NSProcessInfo</span> processInfo].globallyUniqueString;</span><br><span class="line"></span><br><span class="line">     <span class="keyword">return</span> [<span class="built_in">NSURL</span> fileURLWithPath:[<span class="built_in">NSTemporaryDirectory</span>() stringByAppendingString:uniqueName]];</span><br><span class="line"></span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">- (<span class="type">void</span>)copyStoreWithName:(<span class="built_in">NSString</span> *)name toURL:(<span class="built_in">NSURL</span> *)url</span><br><span class="line"></span><br><span class="line">&#123;</span><br><span class="line"></span><br><span class="line">     <span class="comment">// 每次创建一个唯一的url以保证测试正常运行</span></span><br><span class="line"></span><br><span class="line">     <span class="built_in">NSBundle</span> *bundle = [<span class="built_in">NSBundle</span> bundleForClass:[<span class="keyword">self</span> <span class="keyword">class</span>]];</span><br><span class="line"></span><br><span class="line">     <span class="built_in">NSFileManager</span> *fileManager = [<span class="built_in">NSFileManager</span> new];</span><br><span class="line"></span><br><span class="line">     <span class="built_in">NSString</span> *path = [bundle pathForResource:[name stringByDeletingPathExtension] ofType:name.pathExtension];</span><br><span class="line"></span><br><span class="line">     [fileManager copyItemAtPath:path</span><br><span class="line"></span><br><span class="line">          toPath:url.path error:<span class="literal">nil</span>];</span><br><span class="line"></span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="comment">//在测试类中复用</span></span><br><span class="line"></span><br><span class="line">- (<span class="type">void</span>)setUp</span><br><span class="line"></span><br><span class="line">&#123;</span><br><span class="line"></span><br><span class="line">     [<span class="variable language_">super</span> setUp];</span><br><span class="line"></span><br><span class="line">     [<span class="keyword">self</span> setUpCoreDataStackMigratingFromStoreWithName:<span class="string">@&quot;Model1.sqlite&quot;</span>];</span><br><span class="line"></span><br><span class="line">&#125;</span><br><span class="line"></span><br></pre></td></tr></table></figure>

<p>调试迁移一个有用的启动参数是-com.apple.CoreData.MigrationDebug，设置1就会在console收到迁移数据时会出现的特殊的情况的信息。如果设置-com.apple.CoreData.SQLDebug 为 1还能够在console看到实际操作的SQL语句。</p>
<h1 id="Core-Data的并行处理"><a href="#Core-Data的并行处理" class="headerlink" title="Core Data的并行处理"></a>Core Data的并行处理</h1><ul>
<li>官方文档有基本规则：<a target="_blank" rel="noopener" href="https://developer.apple.com/library/mac/#documentation/cocoa/conceptual/CoreData/Articles/cdConcurrency.html">https://developer.apple.com/library/mac/#documentation/cocoa/conceptual/CoreData/Articles/cdConcurrency.html</a></li>
<li>处理步骤，先创建一个操作，创建一个managed object context，和main managed object context使用同样的persistent store coordinator，当context保存后就通知main managed object context，后再合并变化。可以参考这个范例<a target="_blank" rel="noopener" href="https://github.com/objcio/issue-2-background-core-data">https://github.com/objcio/issue-2-background-core-data</a></li>
</ul>
<h1 id="性能测试"><a href="#性能测试" class="headerlink" title="性能测试"></a>性能测试</h1><ul>
<li>加上-com.apple.CoreData.SQLDebug1 作为启动参数传递给应用程序可以得到的输出</li>
</ul>
<figure class="highlight objc"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line"></span><br><span class="line">sql: SELECT <span class="number">0</span>, t0.Z_PK, t0.Z_OPT, t0.ZIDENTIFIER, t0.ZLATITUDE, t0.ZLONGITUDE, t0.ZNAME FROM ZSTOP t0 WHERE (? &lt;= t0.ZLONGITUDE AND t0.ZLONGITUDE &lt;= ? AND ? &lt;= t0.ZLATITUDE AND t0.ZLATITUDE &lt;= ?) LIMIT <span class="number">100</span></span><br><span class="line"></span><br><span class="line">annotation: sql connection fetch time: <span class="number">0.0008</span>s</span><br><span class="line"></span><br><span class="line">annotation: total fetch execution time: <span class="number">0.0013</span>s <span class="keyword">for</span> <span class="number">15</span> rows.</span><br><span class="line"></span><br></pre></td></tr></table></figure>

<p>实际生成的SQL是：</p>
<figure class="highlight objc"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line">SELECT <span class="number">0</span>, t0.Z_PK, t0.Z_OPT, t0.ZIDENTIFIER, t0.ZLATITUDE, t0.ZLONGITUDE, t0.ZNAME FROM ZSTOP t0</span><br><span class="line"></span><br><span class="line">WHERE (? &lt;= t0.ZLONGITUDE AND t0.ZLONGITUDE &lt;= ? AND ? &lt;= t0.ZLATITUDE AND t0.ZLATITUDE &lt;= ?)</span><br><span class="line"></span><br><span class="line">LIMIT <span class="number">200</span></span><br><span class="line"></span><br></pre></td></tr></table></figure>

<ul>
<li>使用SQL 的EXPLAIN命令<a target="_blank" rel="noopener" href="https://www.sqlite.org/eqp.html">https://www.sqlite.org/eqp.html</a>对性能调查研究</li>
</ul>
  <figure class="highlight objc"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br></pre></td><td class="code"><pre><span class="line"></span><br><span class="line">% cd TrafficSearch</span><br><span class="line"></span><br><span class="line">% sqlite3 transit-data.sqlite</span><br><span class="line"></span><br><span class="line">SQLite version <span class="number">3.7</span><span class="number">.13</span> <span class="number">2012</span><span class="number">-07</span><span class="number">-17</span> <span class="number">17</span>:<span class="number">46</span>:<span class="number">21</span></span><br><span class="line"></span><br><span class="line">Enter <span class="string">&quot;.help&quot;</span> <span class="keyword">for</span> instructions</span><br><span class="line"></span><br><span class="line">Enter SQL statements terminated with a <span class="string">&quot;;&quot;</span></span><br><span class="line"></span><br><span class="line">sqlite&gt; EXPLAIN QUERY PLAN SELECT <span class="number">0</span>, t0.Z_PK, t0.Z_OPT, t0.ZIDENTIFIER, t0.ZLATITUDE, t0.ZLONGITUDE, t0.ZNAME FROM ZSTOP t0</span><br><span class="line"></span><br><span class="line">...&gt; WHERE (<span class="number">13.30845219672199</span> &lt;= t0.ZLONGITUDE AND t0.ZLONGITUDE &lt;= <span class="number">13.33441458422844</span> AND <span class="number">52.42769566863058</span> &lt;= t0.ZLATITUDE AND t0.ZLATITUDE &lt;= <span class="number">52.44352370653525</span>)</span><br><span class="line"></span><br><span class="line">...&gt; LIMIT <span class="number">100</span>;</span><br><span class="line"></span><br><span class="line"><span class="number">0</span>|<span class="number">0</span>|<span class="number">0</span>|SEARCH TABLE ZSTOP AS t0 USING INDEX ZSTOP_ZLONGITUDE_INDEX (ZLONGITUDE&gt;? AND ZLONGITUDE&lt;?) (~<span class="number">6944</span> rows)</span><br><span class="line"></span><br></pre></td></tr></table></figure>
<p>输出</p>
<figure class="highlight objc"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line"><span class="number">0</span>|<span class="number">0</span>|<span class="number">0</span>|SEARCH TABLE ZSTOP AS t0 USING INDEX ZSTOP_ZLONGITUDE_ZLATITUDE (ZLONGITUDE&gt;? AND ZLONGITUDE&lt;?) (~<span class="number">6944</span> rows)</span><br><span class="line"></span><br></pre></td></tr></table></figure>

    </div>

    
    
    

      <footer class="post-footer">
          <div class="post-tags">
              <a href="/tags/iOS/" rel="tag"># iOS</a>
              <a href="/tags/Core-Data/" rel="tag"># Core Data</a>
              <a href="/tags/%E6%95%B0%E6%8D%AE%E5%AD%98%E5%82%A8/" rel="tag"># 数据存储</a>
              <a href="/tags/%E6%95%B0%E6%8D%AE%E5%BA%93/" rel="tag"># 数据库</a>
              <a href="/tags/%E6%8C%81%E4%B9%85%E5%8C%96/" rel="tag"># 持久化</a>
          </div>

        


        
    <div class="post-nav">
      <div class="post-nav-item">
    <a href="/2016/05/23/Markdown-%E5%85%A5%E9%97%A8/" rel="prev" title="Markdown 入门">
      <i class="fa fa-chevron-left"></i> Markdown 入门
    </a></div>
      <div class="post-nav-item">
    <a href="/2016/10/06/%E5%9B%BE%E5%83%8F%E5%A4%84%E7%90%86/" rel="next" title="图像处理">
      图像处理 <i class="fa fa-chevron-right"></i>
    </a></div>
    </div>
      </footer>
    
  </article>
  
  
  



          </div>
          

<script>
  window.addEventListener('tabs:register', () => {
    let { activeClass } = CONFIG.comments;
    if (CONFIG.comments.storage) {
      activeClass = localStorage.getItem('comments_active') || activeClass;
    }
    if (activeClass) {
      let activeTab = document.querySelector(`a[href="#comment-${activeClass}"]`);
      if (activeTab) {
        activeTab.click();
      }
    }
  });
  if (CONFIG.comments.storage) {
    window.addEventListener('tabs:click', event => {
      if (!event.target.matches('.tabs-comment .tab-content .tab-pane')) return;
      let commentClass = event.target.classList[1];
      localStorage.setItem('comments_active', commentClass);
    });
  }
</script>

        </div>
          
  
  <div class="toggle sidebar-toggle">
    <span class="toggle-line toggle-line-first"></span>
    <span class="toggle-line toggle-line-middle"></span>
    <span class="toggle-line toggle-line-last"></span>
  </div>

  <aside class="sidebar">
    <div class="sidebar-inner">

      <ul class="sidebar-nav motion-element">
        <li class="sidebar-nav-toc">
          文章目录
        </li>
        <li class="sidebar-nav-overview">
          站点概览
        </li>
      </ul>

      <!--noindex-->
      <div class="post-toc-wrap sidebar-panel">
          <div class="post-toc motion-element"><ol class="nav"><li class="nav-item nav-level-1"><a class="nav-link" href="#%E5%8C%85%E5%90%AB%E7%BB%84%E4%BB%B6"><span class="nav-number">1.</span> <span class="nav-text">包含组件</span></a></li><li class="nav-item nav-level-1"><a class="nav-link" href="#%E8%AE%BE%E7%BD%AE%E5%A0%86%E6%A0%88"><span class="nav-number">2.</span> <span class="nav-text">设置堆栈</span></a></li><li class="nav-item nav-level-1"><a class="nav-link" href="#%E5%88%9B%E5%BB%BA%E6%A8%A1%E5%9E%8B"><span class="nav-number">3.</span> <span class="nav-text">创建模型</span></a><ol class="nav-child"><li class="nav-item nav-level-2"><a class="nav-link" href="#%E6%A8%A1%E5%9E%8B%E7%9A%84%E5%B1%9E%E6%80%A7"><span class="nav-number">3.1.</span> <span class="nav-text">模型的属性</span></a></li></ol></li><li class="nav-item nav-level-1"><a class="nav-link" href="#%E5%88%9B%E5%BB%BAStore%E7%B1%BB"><span class="nav-number">4.</span> <span class="nav-text">创建Store类</span></a></li><li class="nav-item nav-level-1"><a class="nav-link" href="#%E5%92%8CTable-View%E6%97%A0%E7%BC%9D%E7%BB%93%E5%90%88"><span class="nav-number">5.</span> <span class="nav-text">和Table View无缝结合</span></a><ol class="nav-child"><li class="nav-item nav-level-2"><a class="nav-link" href="#%E5%88%9B%E5%BB%BA%E4%B8%80%E4%B8%AANSFetchedResultsController%E4%BD%9C%E4%B8%BAtable-view%E7%9A%84data-source"><span class="nav-number">5.1.</span> <span class="nav-text">创建一个NSFetchedResultsController作为table view的data source</span></a></li><li class="nav-item nav-level-2"><a class="nav-link" href="#%E5%88%9B%E5%BB%BATable-View-Controller"><span class="nav-number">5.2.</span> <span class="nav-text">创建Table View Controller</span></a></li><li class="nav-item nav-level-2"><a class="nav-link" href="#%E6%B7%BB%E5%8A%A0%E5%9C%A8textFieldShouldReturn%EF%BC%9A%E9%87%8C"><span class="nav-number">5.3.</span> <span class="nav-text">添加在textFieldShouldReturn：里</span></a></li><li class="nav-item nav-level-2"><a class="nav-link" href="#%E5%A2%9E%E5%88%A0%E6%94%B9%E5%90%8Etable-view%E4%B9%9F%E4%BC%9A%E6%9B%B4%E6%94%B9%E6%98%BE%E7%A4%BA"><span class="nav-number">5.4.</span> <span class="nav-text">增删改后table view也会更改显示</span></a></li></ol></li><li class="nav-item nav-level-1"><a class="nav-link" href="#%E5%92%8CCollection-View%E7%9A%84%E7%BB%93%E5%90%88"><span class="nav-number">6.</span> <span class="nav-text">和Collection View的结合</span></a></li><li class="nav-item nav-level-1"><a class="nav-link" href="#%E5%A6%82%E4%BD%95%E4%BC%A0%E9%80%92Table-view%E9%87%8C%E7%9A%84Model%E5%AF%B9%E8%B1%A1%E5%88%B0%E6%96%B0%E7%9A%84view-controller%E4%B8%AD"><span class="nav-number">7.</span> <span class="nav-text">如何传递Table view里的Model对象到新的view controller中</span></a></li><li class="nav-item nav-level-1"><a class="nav-link" href="#%E5%88%A0%E9%99%A4"><span class="nav-number">8.</span> <span class="nav-text">删除</span></a></li><li class="nav-item nav-level-1"><a class="nav-link" href="#%E6%8E%92%E5%BA%8F"><span class="nav-number">9.</span> <span class="nav-text">排序</span></a></li><li class="nav-item nav-level-1"><a class="nav-link" href="#%E4%BF%9D%E5%AD%98"><span class="nav-number">10.</span> <span class="nav-text">保存</span></a></li><li class="nav-item nav-level-1"><a class="nav-link" href="#Fetch%E8%8E%B7%E5%8F%96%E5%AF%B9%E8%B1%A1"><span class="nav-number">11.</span> <span class="nav-text">Fetch获取对象</span></a><ol class="nav-child"><li class="nav-item nav-level-2"><a class="nav-link" href="#%E5%9F%BA%E7%A1%80"><span class="nav-number">11.1.</span> <span class="nav-text">基础</span></a></li><li class="nav-item nav-level-2"><a class="nav-link" href="#%E8%8C%83%E4%BE%8B"><span class="nav-number">11.2.</span> <span class="nav-text">范例</span></a></li></ol></li><li class="nav-item nav-level-1"><a class="nav-link" href="#%E5%AF%BC%E5%85%A5%E5%A4%A7%E9%87%8F%E6%95%B0%E6%8D%AE"><span class="nav-number">12.</span> <span class="nav-text">导入大量数据</span></a><ol class="nav-child"><li class="nav-item nav-level-2"><a class="nav-link" href="#%E5%BA%94%E7%94%A8Bundle%E9%87%8C%E7%9A%84SQLite%E6%96%87%E4%BB%B6"><span class="nav-number">12.1.</span> <span class="nav-text">应用Bundle里的SQLite文件</span></a></li><li class="nav-item nav-level-2"><a class="nav-link" href="#%E5%AF%BC%E5%85%A5%E8%8C%83%E4%BE%8B"><span class="nav-number">12.2.</span> <span class="nav-text">导入范例</span></a></li></ol></li><li class="nav-item nav-level-1"><a class="nav-link" href="#%E7%89%88%E6%9C%AC%E8%BF%81%E7%A7%BB"><span class="nav-number">13.</span> <span class="nav-text">版本迁移</span></a><ol class="nav-child"><li class="nav-item nav-level-2"><a class="nav-link" href="#Mapping-Models"><span class="nav-number">13.1.</span> <span class="nav-text">Mapping Models</span></a></li><li class="nav-item nav-level-2"><a class="nav-link" href="#Progressive-Migrations%E6%B8%90%E8%BF%9B%E5%BC%8F%E8%BF%81%E7%A7%BB"><span class="nav-number">13.2.</span> <span class="nav-text">Progressive Migrations渐进式迁移</span></a></li><li class="nav-item nav-level-2"><a class="nav-link" href="#%E8%BF%81%E7%A7%BB%E7%AD%96%E7%95%A5"><span class="nav-number">13.3.</span> <span class="nav-text">迁移策略</span></a></li></ol></li><li class="nav-item nav-level-1"><a class="nav-link" href="#Core-Data%E7%9A%84%E5%B9%B6%E8%A1%8C%E5%A4%84%E7%90%86"><span class="nav-number">14.</span> <span class="nav-text">Core Data的并行处理</span></a></li><li class="nav-item nav-level-1"><a class="nav-link" href="#%E6%80%A7%E8%83%BD%E6%B5%8B%E8%AF%95"><span class="nav-number">15.</span> <span class="nav-text">性能测试</span></a></li></ol></div>
      </div>
      <!--/noindex-->

      <div class="site-overview-wrap sidebar-panel">
        <div class="site-author motion-element" itemprop="author" itemscope itemtype="http://schema.org/Person">
  <p class="site-author-name" itemprop="name">suwang</p>
  <div class="site-description" itemprop="description">Tech Blog</div>
</div>
<div class="site-state-wrap motion-element">
  <nav class="site-state">
      <div class="site-state-item site-state-posts">
          <a href="/archives/">
        
          <span class="site-state-item-count">61</span>
          <span class="site-state-item-name">日志</span>
        </a>
      </div>
      <div class="site-state-item site-state-categories">
        <span class="site-state-item-count">14</span>
        <span class="site-state-item-name">分类</span>
      </div>
      <div class="site-state-item site-state-tags">
        <span class="site-state-item-count">46</span>
        <span class="site-state-item-name">标签</span>
      </div>
  </nav>
</div>



      </div>

    </div>
  </aside>
  <div id="sidebar-dimmer"></div>


      </div>
    </main>

    <footer class="footer">
      <div class="footer-inner">
        

        

<div class="copyright">
  
  &copy; 
  <span itemprop="copyrightYear">2025</span>
  <span class="with-love">
    <i class="fa fa-heart"></i>
  </span>
  <span class="author" itemprop="copyrightHolder">suwang</span>
</div>
  <div class="powered-by">由 <a href="https://hexo.io/" class="theme-link" rel="noopener" target="_blank">Hexo</a> & <a href="https://muse.theme-next.org/" class="theme-link" rel="noopener" target="_blank">NexT.Muse</a> 强力驱动
  </div>

        








      </div>
    </footer>
  </div>

  
  <script src="/lib/anime.min.js"></script>
  <script src="/lib/velocity/velocity.min.js"></script>
  <script src="/lib/velocity/velocity.ui.min.js"></script>

<script src="/js/utils.js"></script>

<script src="/js/motion.js"></script>


<script src="/js/schemes/muse.js"></script>


<script src="/js/next-boot.js"></script>




  















  

  

</body>
</html>
